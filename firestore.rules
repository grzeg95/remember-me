rules_version = '2';

service cloud.firestore {

	match /databases/{database}/documents/users/{userId} {

    function isOwner() {
      return userId == request.auth.uid
    }

    function _getUser() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function _userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid))
    }

    function _isDisabled(user) {
      return 'disabled' in user.data ? user.data.disabled : false
    }

    function isDisabled() {
    	return _userExists() == false ? false : _isDisabled(_getUser())
    }

    function userHasTimeOfDayAndIsNotDisabled(timeOfDay) {
      let user = get(/databases/$(database)/documents/users/$(request.auth.uid));
      let timesOfDay = user.data.timesOfDay;
      return _userExists() && !_isDisabled(user) && (timesOfDay != null && timeOfDay in timesOfDay)
    }

    allow get: if isOwner() && !isDisabled()

    match /today/{day}/task/{taskId} {
      allow list: if isOwner() && !isDisabled() && day in ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun']
        && request.query.orderBy.description == 'ASC'
      	&& request.query.limit == 50 * 20

      // set progress
      allow update: if isOwner()
        && exists(/databases/$(database)/documents/users/$(userId)/task/$(taskId))
        && userHasTimeOfDayAndIsNotDisabled(resource.data.timesOfDay.keys()[0])
        && request.resource.data.diff(resource.data).affectedKeys() == ['timesOfDay'].toSet()
        && request.resource.data.timesOfDay.diff(resource.data.timesOfDay).affectedKeys().size() == 1
        && request.resource.data.timesOfDay.diff(resource.data.timesOfDay).changedKeys().size() == 1
        && request.resource.data.timesOfDay.values().toSet().hasOnly([true, false])
    }

    match /task/{taskId} {
    	allow get: if isOwner() && !isDisabled()
      allow list: if
      	isOwner() && !isDisabled()
      	&& request.query.orderBy.description == 'ASC'
      	&& request.query.limit == 50
    }

  }

}
