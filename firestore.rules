rules_version = '2';

service cloud.firestore {

	match /databases/{database}/documents/users/{userId} {

    function isOwner() {
      return userId == request.auth.uid
    }

    // https://firebase.google.com/docs/firestore/pricing#firestore-rules
    // You are only charged one read per dependent document even if your rules refer to that document more than once
    function isDisabled() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('disabled', false)
    }

    function allowSetProgress(taskId) {
      return isOwner() && !isDisabled()
        && exists(/databases/$(database)/documents/users/$(userId)/task/$(taskId))
        && request.resource.data.diff(resource.data).affectedKeys() == ['timesOfDay'].toSet()
        && request.resource.data.timesOfDay.diff(resource.data.timesOfDay).affectedKeys().size() == 1
        && request.resource.data.timesOfDay.diff(resource.data.timesOfDay).changedKeys().size() == 1
        && request.resource.data.timesOfDay.values().toSet().hasOnly([true, false])
    }

    allow get: if isOwner() && !isDisabled()

    match /today/{day}/task/{taskId} {
      allow list: if isOwner() && !isDisabled()
        && day in ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun']
        && request.query.orderBy.description == 'ASC'
      	&& request.query.limit == 50 * 20

      // set progress
      allow update: if allowSetProgress(taskId)
    }

    match /task/{taskId} {
    	allow get: if isOwner() && !isDisabled()
      allow list: if isOwner() && !isDisabled()
      	&& request.query.orderBy.description == 'ASC'
      	&& request.query.limit == 50
    }
  }
}
